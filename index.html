import telebot
import json
from datetime import datetime
from telebot.types import WebAppInfo, InlineKeyboardMarkup, InlineKeyboardButton

# ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ò–ó–ú–ï–ù–ò–¢–ï!
BOT_TOKEN = '7688653923:AAG6y5iP8V0vszJBJ-3cW8vyP3TuDMAcxyY'  # –¢–æ–∫–µ–Ω –æ—Ç @BotFather
ADMIN_ID = 486854885  # –í–∞—à Telegram ID (–ø–æ–ª—É—á–∏—Ç—å —É @userinfobot)
MINI_APP_URL = 'https://timmir1.github.io/Vivoz-musora/'  # URL –≤–∞—à–µ–≥–æ Mini App

bot = telebot.TeleBot(BOT_TOKEN)

# –ö–æ–º–∞–Ω–¥–∞ /start - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
@bot.message_handler(commands=['start'])
def send_welcome(message):
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton(
        text="üõçÔ∏è –û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω", 
        web_app=WebAppInfo(url=MINI_APP_URL)
    ))
    
    welcome_text = """
üõçÔ∏è <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Tech Shop!</b>

üì± –£ –Ω–∞—Å –µ—Å—Ç—å –ª—É—á—à–∏–µ –≥–∞–¥–∂–µ—Ç—ã –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã:
‚Ä¢ iPhone, MacBook, iPad
‚Ä¢ AirPods, Apple Watch
‚Ä¢ AirTag –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ

–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ üëá
    """
    
    bot.send_message(
        message.chat.id,
        welcome_text,
        parse_mode='HTML',
        reply_markup=markup
    )

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –∏–∑ Mini App
@bot.message_handler(content_types=['web_app_data'])
def handle_order(message):
    try:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –∏–∑ Mini App
        order_data = json.loads(message.web_app_data.data)
        user = message.from_user
        user_name = f"{user.first_name} {user.last_name or ''}".strip()
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
        order_number = f"{datetime.now().strftime('%Y%m%d')}{user.id % 1000:03d}"
        
        # 1Ô∏è‚É£ –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ö–õ–ò–ï–ù–¢–£
        client_message = f"""
‚úÖ <b>–ó–∞–∫–∞–∑ #{order_number} –ø—Ä–∏–Ω—è—Ç!</b>

üì¶ <b>–í–∞—à –∑–∞–∫–∞–∑:</b>
"""
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
        for item in order_data['items']:
            client_message += f"‚Ä¢ {item['name']} - {item['quantity']} —à—Ç. √ó {item['price']:,} ‚ÇΩ\n"
        
        client_message += f"""
üí∞ <b>–ò—Ç–æ–≥–æ: {order_data['totalAmount']:,} ‚ÇΩ</b>

üìû –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞.

üéâ –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!
        """
        
        bot.send_message(
            message.chat.id,
            client_message,
            parse_mode='HTML'
        )
        
        # 2Ô∏è‚É£ –û–¢–ü–†–ê–í–õ–Ø–ï–ú –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–£
        admin_message = f"""
üîî <b>–ù–û–í–´–ô –ó–ê–ö–ê–ó #{order_number}</b>

üë§ <b>–ö–ª–∏–µ–Ω—Ç:</b> {user_name}
üÜî <b>Username:</b> @{user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'}
üîó <b>ID:</b> {user.id}
üìÖ <b>–î–∞—Ç–∞:</b> {datetime.now().strftime('%d.%m.%Y %H:%M')}

üõí <b>–ó–ê–ö–ê–ó:</b>
"""
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞
        for item in order_data['items']:
            admin_message += f"""
üì± <b>{item['name']}</b>
   üí∞ –¶–µ–Ω–∞: {item['price']:,} ‚ÇΩ
   üì¶ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {item['quantity']} —à—Ç.
   üíµ –°—É–º–º–∞: {item['total']:,} ‚ÇΩ
"""
        
        admin_message += f"\nüí∞ <b>–ò–¢–û–ì–û: {order_data['totalAmount']:,} ‚ÇΩ</b>"
        
        # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        admin_markup = InlineKeyboardMarkup()
        admin_markup.row(
            InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data=f"confirm_{user.id}_{order_number}"),
            InlineKeyboardButton("‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"reject_{user.id}_{order_number}")
        )
        admin_markup.add(
            InlineKeyboardButton("üìû –ù–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É", url=f"tg://user?id={user.id}")
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω—É
        bot.send_message(
            ADMIN_ID,
            admin_message,
            parse_mode='HTML',
            reply_markup=admin_markup
        )
        
        # –õ–æ–≥–∏—Ä—É–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å
        print(f"‚úÖ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #{order_number}")
        print(f"üë§ –ö–ª–∏–µ–Ω—Ç: {user_name} (ID: {user.id})")
        print(f"üí∞ –°—É–º–º–∞: {order_data['totalAmount']:,} ‚ÇΩ")
        print(f"üì¶ –¢–æ–≤–∞—Ä–æ–≤: {len(order_data['items'])}")
        print("-" * 50)
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞: {e}")
        bot.send_message(
            message.chat.id,
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞.\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
        )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
@bot.callback_query_handler(func=lambda call: True)
def handle_admin_buttons(call):
    try:
        # –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏: action_userId_orderNumber
        parts = call.data.split('_')
        action = parts[0]  # confirm –∏–ª–∏ reject
        user_id = int(parts[1])
        order_number = parts[2]
        
        if action == 'confirm':
            # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –∑–∞–∫–∞–∑
            bot.send_message(
                user_id,
                f"""
‚úÖ <b>–ó–∞–∫–∞–∑ #{order_number} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!</b>

üéâ –û—Ç–ª–∏—á–Ω–æ! –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –≤ —Ä–∞–±–æ—Ç—É.

üì¶ –ú—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º —Ç–æ–≤–∞—Ä—ã –∏ —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –¥–æ—Å—Ç–∞–≤–∫–∏.

‚è∞ –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏: 1-2 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è.

–°–ø–∞—Å–∏–±–æ –∑–∞ –¥–æ–≤–µ—Ä–∏–µ! üôè
                """,
                parse_mode='HTML'
            )
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞
            bot.edit_message_text(
                f"{call.message.text}\n\n‚úÖ <b>–ó–ê–ö–ê–ó –ü–û–î–¢–í–ï–†–ñ–î–ï–ù</b>",
                call.message.chat.id,
                call.message.message_id,
                parse_mode='HTML'
            )
            
            bot.answer_callback_query(call.id, f"‚úÖ –ó–∞–∫–∞–∑ #{order_number} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!")
            
        elif action == 'reject':
            # –û—Ç–∫–ª–æ–Ω—è–µ–º –∑–∞–∫–∞–∑
            bot.send_message(
                user_id,
                f"""
‚ùå <b>–ó–∞–∫–∞–∑ #{order_number} –æ—Ç–∫–ª–æ–Ω–µ–Ω</b>

üòî –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –º—ã –Ω–µ –º–æ–∂–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤–∞—à –∑–∞–∫–∞–∑ –ø–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –ø—Ä–∏—á–∏–Ω–∞–º.

–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
‚Ä¢ –¢–æ–≤–∞—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ
‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ–ø–æ–ª–∞–¥–∫–∏ –≤ —Å–∏—Å—Ç–µ–º–µ

üîÑ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–µ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.

–ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞! üôè
                """,
                parse_mode='HTML'
            )
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞
            bot.edit_message_text(
                f"{call.message.text}\n\n‚ùå <b>–ó–ê–ö–ê–ó –û–¢–ö–õ–û–ù–ï–ù</b>",
                call.message.chat.id,
                call.message.message_id,
                parse_mode='HTML'
            )
            
            bot.answer_callback_query(call.id, f"‚ùå –ó–∞–∫–∞–∑ #{order_number} –æ—Ç–∫–ª–æ–Ω–µ–Ω")
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω–∞: {e}")
        bot.answer_callback_query(call.id, "‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è")

# –ö–æ–º–∞–Ω–¥–∞ /help - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
@bot.message_handler(commands=['help'])
def send_help(message):
    help_text = """
ü§ñ <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>

/start - –û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É

üí° <b>–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑:</b>
1. –ù–∞–∂–º–∏—Ç–µ /start
2. –û—Ç–∫—Ä–æ–π—Ç–µ –º–∞–≥–∞–∑–∏–Ω
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã
4. –û—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑
5. –ñ–¥–∏—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

üìû <b>–ü–æ–¥–¥–µ—Ä–∂–∫–∞:</b> @–≤–∞—à_username
    """
    
    bot.send_message(message.chat.id, help_text, parse_mode='HTML')

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
@bot.message_handler(func=lambda message: True)
def handle_other_messages(message):
    bot.send_message(
        message.chat.id,
        "ü§ñ –ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏—Ç–µ /start —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω.\n\n"
        "–ò–ª–∏ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥."
    )

if __name__ == '__main__':
    print("ü§ñ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–æ–≤...")
    print("‚öôÔ∏è  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:")
    print(f"   üì± Mini App URL: {MINI_APP_URL}")
    print(f"   üë§ Admin ID: {ADMIN_ID}")
    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.")
    print("-" * 50)
    
    try:
        bot.polling(none_stop=True)
    except KeyboardInterrupt:
        print("\nüõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –±–æ—Ç–∞: {e}")
