import telebot
import json
from datetime import datetime
import sqlite3
from telebot.types import WebAppInfo, InlineKeyboardMarkup, InlineKeyboardButton

# –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
BOT_TOKEN = '7688653923:AAFIrE3fRfFIGWyTdjvU_GvrlJzboxoMSZQ'
bot = telebot.TeleBot(BOT_TOKEN)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
def init_database():
    conn = sqlite3.connect('orders.db')
    cursor = conn.cursor()
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∑–∞–∫–∞–∑–æ–≤
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS orders (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            user_name TEXT,
            order_data TEXT,
            total_amount REAL,
            status TEXT DEFAULT 'pending',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞–∫–∞–∑–µ
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS order_items (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            order_id INTEGER,
            product_name TEXT,
            product_price REAL,
            quantity INTEGER,
            total REAL,
            FOREIGN KEY (order_id) REFERENCES orders (id)
        )
    ''')
    
    conn.commit()
    conn.close()

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
def save_order(user_id, user_name, order_data):
    conn = sqlite3.connect('orders.db')
    cursor = conn.cursor()
    
    # –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞
    data = json.loads(order_data)
    total_amount = data.get('totalAmount', 0)
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ
    cursor.execute('''
        INSERT INTO orders (user_id, user_name, order_data, total_amount)
        VALUES (?, ?, ?, ?)
    ''', (user_id, user_name, order_data, total_amount))
    
    order_id = cursor.lastrowid
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞–∫–∞–∑–∞
    for item in data.get('items', []):
        cursor.execute('''
            INSERT INTO order_items (order_id, product_name, product_price, quantity, total)
            VALUES (?, ?, ?, ?, ?)
        ''', (order_id, item['name'], item['price'], item['quantity'], item['total']))
    
    conn.commit()
    conn.close()
    
    return order_id

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
def format_order(order_data):
    data = json.loads(order_data)
    
    message = "üõí <b>–ù–û–í–´–ô –ó–ê–ö–ê–ó</b>\n\n"
    
    for item in data['items']:
        message += f"üì± <b>{item['name']}</b>\n"
        message += f"   –¶–µ–Ω–∞: {item['price']:,} ‚ÇΩ\n"
        message += f"   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {item['quantity']} —à—Ç.\n"
        message += f"   –ò—Ç–æ–≥–æ: {item['total']:,} ‚ÇΩ\n\n"
    
    message += f"üí∞ <b>–û–±—â–∞—è —Å—É–º–º–∞: {data['totalAmount']:,} ‚ÇΩ</b>\n"
    message += f"üìÖ <b>–î–∞—Ç–∞:</b> {datetime.now().strftime('%d.%m.%Y %H:%M')}"
    
    return message

# –ö–æ–º–∞–Ω–¥–∞ /start
@bot.message_handler(commands=['start'])
def send_welcome(message):
    # URL –≤–∞—à–µ–≥–æ Mini App
    web_app_url = "https://–≤–∞—à-username.github.io/telegram-shop"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL
    
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton(
        text="üõçÔ∏è –û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω", 
        web_app=WebAppInfo(url=web_app_url)
    ))
    
    bot.send_message(
        message.chat.id,
        "üõçÔ∏è –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Tech Shop!\n\n"
        "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤:",
        reply_markup=markup
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Mini App
@bot.message_handler(content_types=['web_app_data'])
def handle_webapp_data(message):
    try:
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞
        order_data = message.web_app_data.data
        user = message.from_user
        user_name = f"{user.first_name} {user.last_name or ''}".strip()
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ –±–∞–∑—É
        order_id = save_order(user.id, user_name, order_data)
        
        # –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        data = json.loads(order_data)
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        confirmation_msg = f"‚úÖ <b>–ó–∞–∫–∞–∑ #{order_id} –ø—Ä–∏–Ω—è—Ç!</b>\n\n"
        confirmation_msg += f"–¢–æ–≤–∞—Ä–æ–≤: {len(data['items'])} —à—Ç.\n"
        confirmation_msg += f"–°—É–º–º–∞: {data['totalAmount']:,} ‚ÇΩ\n\n"
        confirmation_msg += "üìû –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç.\n\n"
        confirmation_msg += "–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É! üéâ"
        
        bot.send_message(
            message.chat.id,
            confirmation_msg,
            parse_mode='HTML'
        )
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
        admin_id = YOUR_ADMIN_ID  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à Telegram ID
        admin_message = f"üë§ <b>–ó–∞–∫–∞–∑—á–∏–∫:</b> {user_name} (@{user.username or '–Ω–µ—Ç'})\n"
        admin_message += f"üÜî <b>ID:</b> {user.id}\n"
        admin_message += f"üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {user.phone_number or '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n\n"
        admin_message += format_order(order_data)
        
        # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        admin_markup = InlineKeyboardMarkup()
        admin_markup.row(
            InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data=f"confirm_{order_id}"),
            InlineKeyboardButton("‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"reject_{order_id}")
        )
        admin_markup.add(
            InlineKeyboardButton("üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º", url=f"tg://user?id={user.id}")
        )
        
        bot.send_message(
            admin_id,
            admin_message,
            parse_mode='HTML',
            reply_markup=admin_markup
        )
        
        print(f"–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #{order_id} –æ—Ç {user_name} –Ω–∞ —Å—É–º–º—É {data['totalAmount']} ‚ÇΩ")
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞: {e}")
        bot.send_message(
            message.chat.id,
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
        )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –∫–Ω–æ–ø–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
@bot.callback_query_handler(func=lambda call: True)
def handle_admin_actions(call):
    try:
        action, order_id = call.data.split('_')
        order_id = int(order_id)
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ
        conn = sqlite3.connect('orders.db')
        cursor = conn.cursor()
        cursor.execute('SELECT user_id, user_name, total_amount, status FROM orders WHERE id = ?', (order_id,))
        order = cursor.fetchone()
        
        if not order:
            bot.answer_callback_query(call.id, "‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return
        
        user_id, user_name, total_amount, current_status = order
        
        if action == 'confirm':
            if current_status == 'confirmed':
                bot.answer_callback_query(call.id, "‚úÖ –ó–∞–∫–∞–∑ —É–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω")
                return
                
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
            cursor.execute('UPDATE orders SET status = ? WHERE id = ?', ('confirmed', order_id))
            conn.commit()
            
            # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
            bot.send_message(
                user_id,
                f"‚úÖ <b>–ó–∞–∫–∞–∑ #{order_id} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!</b>\n\n"
                f"–°—É–º–º–∞: {total_amount:,.0f} ‚ÇΩ\n"
                f"–°—Ç–∞—Ç—É—Å: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω ‚úÖ\n\n"
                f"–ú—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º –≤–∞—à –∑–∞–∫–∞–∑ –∏ —É–≤–µ–¥–æ–º–∏–º –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –¥–æ—Å—Ç–∞–≤–∫–µ.",
                parse_mode='HTML'
            )
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            bot.edit_message_text(
                f"{call.message.text}\n\n‚úÖ <b>–ó–ê–ö–ê–ó –ü–û–î–¢–í–ï–†–ñ–î–ï–ù</b>",
                call.message.chat.id,
                call.message.message_id,
                parse_mode='HTML'
            )
            
            bot.answer_callback_query(call.id, f"‚úÖ –ó–∞–∫–∞–∑ #{order_id} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω")
            
        elif action == 'reject':
            if current_status == 'rejected':
                bot.answer_callback_query(call.id, "‚ùå –ó–∞–∫–∞–∑ —É–∂–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω")
                return
                
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
            cursor.execute('UPDATE orders SET status = ? WHERE id = ?', ('rejected', order_id))
            conn.commit()
            
            # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
            bot.send_message(
                user_id,
                f"‚ùå <b>–ó–∞–∫–∞–∑ #{order_id} –æ—Ç–∫–ª–æ–Ω–µ–Ω</b>\n\n"
                f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –º—ã –Ω–µ –º–æ–∂–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤–∞—à –∑–∞–∫–∞–∑.\n"
                f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.",
                parse_mode='HTML'
            )
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            bot.edit_message_text(
                f"{call.message.text}\n\n‚ùå <b>–ó–ê–ö–ê–ó –û–¢–ö–õ–û–ù–ï–ù</b>",
                call.message.chat.id,
                call.message.message_id,
                parse_mode='HTML'
            )
            
            bot.answer_callback_query(call.id, f"‚ùå –ó–∞–∫–∞–∑ #{order_id} –æ—Ç–∫–ª–æ–Ω–µ–Ω")
        
        conn.close()
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∞: {e}")
        bot.answer_callback_query(call.id, "‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è")

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–∫–∞–∑–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
@bot.message_handler(commands=['orders'])
def show_orders(message):
    admin_id = YOUR_ADMIN_ID  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à Telegram ID
    
    if message.from_user.id != admin_id:
        bot.send_message(message.chat.id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ")
        return
    
    conn = sqlite3.connect('orders.db')
    cursor = conn.cursor()
    cursor.execute('''
        SELECT id, user_name, total_amount, status, created_at 
        FROM orders 
        ORDER BY created_at DESC 
        LIMIT 10
    ''')
    orders = cursor.fetchall()
    conn.close()
    
    if not orders:
        bot.send_message(message.chat.id, "üìã –ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç")
        return
    
    message_text = "üìã <b>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–∫–∞–∑–æ–≤:</b>\n\n"
    
    for order in orders:
        order_id, user_name, total_amount, status, created_at = order
        status_emoji = {"pending": "‚è≥", "confirmed": "‚úÖ", "rejected": "‚ùå"}
        
        message_text += f"üõí <b>–ó–∞–∫–∞–∑ #{order_id}</b>\n"
        message_text += f"üë§ {user_name}\n"
        message_text += f"üí∞ {total_amount:,.0f} ‚ÇΩ\n"
        message_text += f"üìä {status_emoji.get(status, '‚ùì')} {status.title()}\n"
        message_text += f"üìÖ {created_at}\n\n"
    
    bot.send_message(message.chat.id, message_text, parse_mode='HTML')

if __name__ == '__main__':
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å:
    BOT_TOKEN = '7688653923:AAFIrE3fRfFIGWyTdjvU_GvrlJzboxoMSZQ'  # –¢–æ–∫–µ–Ω –æ—Ç @BotFather
    YOUR_ADMIN_ID = 486854885  # –í–∞—à Telegram ID (–ø–æ–ª—É—á–∏—Ç—å –º–æ–∂–Ω–æ —É @userinfobot)
    
    print("ü§ñ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
    init_database()
    
    print("üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
    print("üì± Mini App URL –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ —Ñ—É–Ω–∫—Ü–∏–∏ send_welcome()")
    print("‚öôÔ∏è  –ù–µ –∑–∞–±—É–¥—å—Ç–µ —É–∫–∞–∑–∞—Ç—å –≤–∞—à BOT_TOKEN –∏ ADMIN_ID")
    
    bot.polling(none_stop=True)
